#!/bin/bash
# ===================================================================
# ShikshaSetu - Complete Environment Setup
# First-time setup for the entire project
# ===================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
NC='\033[0m'

print_header() {
    echo ""
    echo "======================================================================"
    echo -e "  ${MAGENTA}$1${NC}"
    echo "======================================================================"
    echo ""
}

print_status() { echo -e "${GREEN}âœ“${NC} $1"; }
print_error() { echo -e "${RED}âœ—${NC} $1"; }
print_info() { echo -e "${BLUE}â„¹${NC} $1"; }
print_warning() { echo -e "${YELLOW}âš ${NC} $1"; }

if [ ! -f "config/requirements.txt" ]; then
    print_error "Run this script from project root directory"
    exit 1
fi

print_header "ðŸŽ“ SHIKSHA SETU - ENVIRONMENT SETUP"

# ===================================================================
# 1. Check Prerequisites
# ===================================================================
print_header "Checking Prerequisites"

# Python
if command -v python3 &> /dev/null; then
    PYTHON_VERSION=$(python3 --version | cut -d' ' -f2)
    print_status "Python $PYTHON_VERSION found"
else
    print_error "Python 3.11+ required. Install from python.org"
    exit 1
fi

# Node.js
if command -v node &> /dev/null; then
    NODE_VERSION=$(node --version)
    print_status "Node.js $NODE_VERSION found"
else
    print_warning "Node.js not found. Frontend setup will be skipped."
    SKIP_FRONTEND=1
fi

# Redis
if command -v redis-cli &> /dev/null; then
    if redis-cli ping &> /dev/null 2>&1; then
        print_status "Redis is running"
    else
        print_warning "Redis not running. Start with: redis-server"
    fi
else
    print_warning "Redis not found. Install:"
    print_info "  macOS: brew install redis"
    print_info "  Ubuntu: sudo apt install redis-server"
fi

# PostgreSQL
if command -v psql &> /dev/null; then
    print_status "PostgreSQL found"
else
    print_info "PostgreSQL not found (can use Supabase instead)"
fi

# ===================================================================
# 2. Environment Configuration
# ===================================================================
print_header "Environment Configuration"

if [ ! -f ".env" ]; then
    print_info "Creating .env file..."
    if [ -f ".env.example" ]; then
        cp .env.example .env
        JWT_SECRET=$(python3 -c "import secrets; print(secrets.token_urlsafe(64))")
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s|JWT_SECRET_KEY=.*|JWT_SECRET_KEY=$JWT_SECRET|g" .env
        else
            sed -i "s|JWT_SECRET_KEY=.*|JWT_SECRET_KEY=$JWT_SECRET|g" .env
        fi
        print_status ".env created with secure JWT secret"
        print_warning "Update DATABASE_URL in .env with your credentials"
    else
        print_error ".env.example not found!"
        exit 1
    fi
else
    print_status ".env already exists"
fi

# ===================================================================
# 3. Backend Setup
# ===================================================================
print_header "Backend Setup (Python)"

if [ ! -d ".venv" ]; then
    print_info "Creating virtual environment..."
    python3 -m venv .venv
    print_status "Virtual environment created"
else
    print_status "Virtual environment exists"
fi

source .venv/bin/activate

print_info "Installing Python dependencies..."
pip install --upgrade pip -q
pip install -r config/requirements.txt

print_status "Backend dependencies installed"

# ===================================================================
# 4. Frontend Setup
# ===================================================================
if [ -z "$SKIP_FRONTEND" ]; then
    print_header "Frontend Setup (React)"
    
    cd frontend
    
    if [ ! -d "node_modules" ]; then
        print_info "Installing frontend dependencies..."
        npm install
        print_status "Frontend dependencies installed"
    else
        print_status "Frontend dependencies exist"
    fi
    
    if [ ! -f ".env" ]; then
        echo "VITE_API_BASE_URL=http://localhost:8000" > .env
        print_status "Frontend .env created"
    fi
    
    cd ..
fi

# ===================================================================
# 5. Directory Structure
# ===================================================================
print_header "Creating Directories"

mkdir -p data/{uploads,audio,cache,models} logs
print_status "Required directories created"

# ===================================================================
# 6. Database Initialization
# ===================================================================
print_header "Database Initialization"

print_info "Initializing database..."
python -c "from backend.database import init_db; init_db()" 2>&1 | tee logs/db_init.log

if [ $? -eq 0 ]; then
    print_status "Database initialized"
else
    print_warning "Database init had warnings. Check logs/db_init.log"
fi

# ===================================================================
# 7. Validation
# ===================================================================
print_header "Validating Setup"

if [ -f "scripts/validate_setup.py" ]; then
    python scripts/validate_setup.py
fi

# ===================================================================
# Success
# ===================================================================
print_header "ðŸŽ‰ Setup Complete!"

echo ""
echo "Next steps:"
echo ""
echo "  1. Update .env with your database credentials"
echo "  2. Start the application:"
echo -e "     ${GREEN}./2-start.sh${NC}"
echo ""
echo "  Or start services individually:"
echo -e "     Backend:  ${GREEN}./3-backend.sh${NC}"
echo -e "     Frontend: ${GREEN}./4-frontend.sh${NC}"
echo ""
echo "  Test everything works:"
echo -e "     ${GREEN}./test.sh${NC}"
echo ""
print_header "Happy Coding! ðŸš€"
