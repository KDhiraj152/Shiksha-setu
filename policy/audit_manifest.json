{
  "manifest_version": "1.0.0",
  "created_at": "2024-12-04T02:51:22Z",
  "backup_timestamp": "20251204_025122",
  "purpose": "UNLOCK: Extract hardcoded alignments into configurable policy module",
  "backup_location": "./.backup/20251204_025122/",
  
  "refactored_files": [
    {
      "file": "backend/services/ai_core/safety.py",
      "original_backup": "backups/20251204_025122/safety.py",
      "changes": [
        {
          "original_lines": "def check_input(self, text: str) -> Dict[str, Any]:",
          "original_snippet": "Always checked HARMFUL_PATTERNS and blocked dangerous content unconditionally",
          "new_location": "backend/policy/policy_module.py: should_block_harmful()",
          "reason": "Make harmful content blocking configurable via ALLOW_UNRESTRICTED_MODE"
        },
        {
          "original_lines": "def filter_response(self, response: str, context: Optional[Dict] = None) -> str:",
          "original_snippet": "Always filtered PII and secrets from output unconditionally",
          "new_location": "backend/policy/policy_module.py: should_block_harmful(), process_output()",
          "reason": "Make output filtering configurable while maintaining audit logging"
        }
      ],
      "integration": "Added policy module import, check_input() respects is_unrestricted_mode(), filter_response() checks should_block_harmful()"
    },
    {
      "file": "backend/services/ai_core/engine.py",
      "original_backup": "backups/20251204_025122/engine.py",
      "changes": [
        {
          "original_lines": "_ensure_initialized()",
          "original_snippet": "Hardcoded safety checks without bypass option",
          "new_location": "backend/policy/policy_module.py: get_policy_module()",
          "reason": "Load policy configuration at startup with mode banner"
        },
        {
          "original_lines": "_generate_response()",
          "original_snippet": "block_harmful always checked, no unrestricted path",
          "new_location": "backend/policy/policy_module.py: should_block_harmful()",
          "reason": "Make safety filtering configurable per policy module"
        }
      ],
      "integration": "Added policy import, _ensure_initialized() loads policy config and prints banner, safety checks use policy.should_block_harmful()"
    },
    {
      "file": "backend/services/curriculum_validator.py",
      "original_backup": "backups/20251204_025122/curriculum_validator.py",
      "changes": [
        {
          "original_lines": "def validate_grade_level(self, content: str, expected_grade: int) -> Dict[str, Any]:",
          "original_snippet": "Always validated against NCERT standards, no bypass for unrestricted use",
          "new_location": "backend/policy/policy_module.py: should_enforce_curriculum(), should_validate_grade_level()",
          "reason": "Make curriculum validation configurable for non-educational use cases"
        }
      ],
      "integration": "Added policy import, validate_grade_level() checks policy.should_enforce_curriculum() before running validation"
    },
    {
      "file": "backend/api/main.py",
      "original_backup": "backups/20251204_025122/main.py",
      "changes": [
        {
          "original_lines": "@app.on_event('startup')",
          "original_snippet": "No indication of operating mode at startup",
          "new_location": "backend/policy/policy_module.py: get_mode_banner()",
          "reason": "Print clear mode banner at startup for auditability"
        }
      ],
      "integration": "Import policy module, print mode banner during FastAPI startup"
    }
  ],

  "new_files_created": [
    {
      "file": "backend/policy/__init__.py",
      "purpose": "Package init, exports get_policy_module, PolicyConfig"
    },
    {
      "file": "backend/policy/policy_module.py",
      "purpose": "Core policy engine with all extracted hardcoded logic",
      "key_functions": [
        "is_unrestricted_mode(): Check ALLOW_UNRESTRICTED_MODE env var",
        "should_block_harmful(): Determine if harmful content should be blocked",
        "should_enforce_curriculum(): Check curriculum enforcement setting",
        "should_validate_grade_level(): Check grade validation setting",
        "allow_external_calls(): Check ALLOW_EXTERNAL_CALLS env var",
        "process_input(text): Process input through policy filters",
        "process_output(text): Process output through policy filters",
        "get_mode_banner(): Return ASCII banner indicating current mode"
      ]
    },
    {
      "file": "policy/config.default.json",
      "purpose": "Default policy configuration with all flags documented"
    },
    {
      "file": "scripts/test_policy_toggle.sh",
      "purpose": "Automated unit tests for policy toggle behavior"
    },
    {
      "file": "scripts/smoke_unrestricted.sh",
      "purpose": "Smoke test for unrestricted mode operation"
    }
  ],

  "environment_variables": [
    {
      "name": "ALLOW_UNRESTRICTED_MODE",
      "default": "false",
      "description": "Master toggle for unrestricted mode. When true, bypasses all content filters and curriculum enforcement."
    },
    {
      "name": "ALLOW_EXTERNAL_CALLS",
      "default": "false",
      "description": "Controls external API calls. When false, all inference is local-only. External calls are always logged."
    },
    {
      "name": "POLICY_FILTERS_ENABLED",
      "default": "true",
      "description": "Enable/disable content filtering. Even when disabled, filtering events are logged."
    },
    {
      "name": "POLICY_CURRICULUM_ENABLED",
      "default": "true",
      "description": "Enable/disable curriculum validation. When disabled, skips NCERT standards checking."
    },
    {
      "name": "POLICY_GRADE_VALIDATION_ENABLED",
      "default": "true",
      "description": "Enable/disable grade level validation."
    },
    {
      "name": "POLICY_BLOCK_HARMFUL",
      "default": "true",
      "description": "Enable/disable harmful content blocking."
    },
    {
      "name": "POLICY_FILTER_PII",
      "default": "true",
      "description": "Enable/disable PII filtering in responses."
    },
    {
      "name": "POLICY_FILTER_SECRETS",
      "default": "true",
      "description": "Enable/disable secret/credential filtering."
    }
  ],

  "audit_trail": {
    "always_logged": [
      "Mode banner printed at startup",
      "All external call attempts (regardless of allow/block)",
      "All content that would have been filtered (with reason)",
      "Policy configuration loaded at startup"
    ],
    "log_locations": [
      "stdout (structured JSON logs)",
      "logs/ directory (file-based logs)"
    ]
  },

  "rollback_instructions": {
    "step_1": "Stop all running services: ./stop.sh",
    "step_2": "Restore backups: cp .backup/20251204_025122/*.py.bak to original locations (remove .bak extension)",
    "step_3": "Remove policy module: rm -rf backend/policy/",
    "step_4": "Restart services: ./start.sh"
  }
}
